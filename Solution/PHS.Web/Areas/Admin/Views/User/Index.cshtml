<head>
    <link href="~/Content/themes/base/minified/jquery-ui.min.css" rel="stylesheet" />
    <script src="~/Scripts/jquery-1.7.1.min.js"></script>
    <script src="~/Scripts/jquery-ui-1.8.20.min.js"></script>
</head>

@model IEnumerable<PHS.DB.PHSUser>

@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style type="text/css">
    .div-inline {
        display: inline-block;
    }
</style>
<h2>User Management</h2>
@if (TempData["Message"] != null)
{
    <div class="alert alert-success alert-dismissable fade in" id="successMessage">
        <a href="#" class="close" data-dismiss="alert" aria-label="close">×</a>
        @TempData["Message"]
    </div>
}
<div>
    @using (Html.BeginForm("Index", "User", FormMethod.Get))
    {
    <p>
        <b>Search by:</b>
        User Id:   @Html.RadioButton("SearchBy", "UserId", true)
        Name: @Html.RadioButton("SearchBy", "Name") <br />
        @Html.TextBox("SearchString")
        <button type="submit" class="btn btn-basic" value="Search">
            <span class="glyphicon glyphicon-search"></span> Search
        </button>
    </p>
    }
<p>
    <div>
        @Html.ActionLink("Create New", "CreateUser", "User", null, new { @class = "btn btn-primary" })
        <div class="dropdown div-inline">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
                Other Actions
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
                <li><a id="Activate" onclick="opendatedialog();">Activate</a></li>
                <li><a id="Inactivate">Inactivate</a></li>
                <li><a id="Resetpassword">Reset Password</a></li>
            </ul>
        </div>
    </div>
</p>
</div>

@if (Model !=null && Model.Count()> 0)
{
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th></th>
                    <th>
                        @Html.DisplayNameFor(model => model.Username)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.IsActive)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.FullName)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.Role)
                    </th>
                    <th>
                        @Html.DisplayNameFor(model => model.ContactNumber)
                    </th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            @foreach(var item in Model) {
                <tr>
                    <td class="vcenter">
                        <input type = "checkbox" id="checkboxid" name="selectedUsers" value="@item.Username" />
                    </td>
                    <td>
                        @Html.ActionLink(item.Username, "UserDetails", new { userID = item.PHSUserID })
                    </td>
                    <td>
                        @if(item.IsActive == true) {
                            <span class="glyphicon glyphicon-ok-sign" style="color:green"></span>
                        }
                        else
                        {
                            <span class="glyphicon glyphicon-minus-sign" style="color:grey"></span>
                        }
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.FullName)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Role)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.ContactNumber)
                    </td>
                    <td>
                        @Html.ActionLink(
                            " ",
                            "EditUser",
                            "User",
                            new { userID = item.PHSUserID },
                            new
                            {
                                @class = "glyphicon glyphicon-edit"
                            })
                    </td>
                    <td>
                        @Html.ActionLink(
                            " ",
                            "DeleteUser",
                            "User",
                            new { userID = item.PHSUserID },
                            new
                            {
                                @onclick = "return confirm('Are you sure you want to delete this User');",
                                @class = "glyphicon glyphicon-trash"
                            })
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>
}
<div id="datepickerdialog" style="display:none">
    <br />
    <div class="form-group">
        <label class="control-label col-md-4" for="EffectiveStartDate">Effective Start Date</label>
        <div class="col-md-8">
            <input class="form-control datepickerstart" id="EffectiveStartDate" name="EffectiveStartDate" type="text" value="">
        </div>
    </div><br><br>
    <div class="form-group">
        <label class="control-label col-md-4" for="EffectiveEndDate">Effective End Date</label>
        <div class="col-md-8">
            <input class="form-control datepickerend" id="EffectiveEndDate" name="EffectiveEndDate" type="text" value="">
        </div>
    </div>
</div>
<script>
    function getCheckedUsers() {
        var checkedUsers = [];
        var inputElements = document.getElementsByName('selectedUsers');
        for (var i = 0; inputElements[i]; ++i) {
            if (inputElements[i].checked) {
                checkedUsers.push(inputElements[i].value);
            }
        }
        return checkedUsers;
    }
    $(function () {
        $('.datepickerstart').datepicker(
            {
                minDate: 0,
                dateFormat: 'yy-mm-dd'
            }).datepicker("setDate", "0");
        $('.datepickerend').datepicker(
            {
                minDate: 0,
                dateFormat: 'yy-mm-dd'
            }).datepicker("setDate", "2099/12/31");
    });
    function opendatedialog() {
        $("#datepickerdialog").dialog({
            height: 300,
            width: 500,
            modal: true,
            resizable: false,
            buttons: {
                "OK": function () {
                    var viewUrl = '@Url.Action("Activate", "User")';
                    $.post(viewUrl, { selectedusers: getCheckedUsers(), startDate: $('.datepickerstart').val(), endDate: $('.datepickerend').val() });
                    $(this).dialog("close");
                    location.reload();
                    return true;
                },
                "Cancel": function () { $(this).dialog("close"); return false; }
            },
            open: function () {
                $(this).siblings('.ui-dialog-buttonpane').find("button:contains('OK')").focus();
            }
        });
    }

    $('#Inactivate').click(function () {
        var answer = confirm("Are you sure you want to inactivate user?")
        if (answer) {
            var viewUrl = '@Url.Action("Inactivate", "User")';
            $.post(viewUrl, { selectedusers: getCheckedUsers() });
            location.reload();
        }
        return true;
    });

    $('#Resetpassword').click(function () {
        var answer = confirm("Are you sure you want to reset password?")
        if (answer) {
            var viewUrl = '@Url.Action("ResetPassword", "User")';
            $.post(viewUrl, { selectedusers: getCheckedUsers() });
            location.reload();
        }
        return true;
    });

</script>